 <!DOCTYPE html>
<html>
<head>
    <title>Elaw.my</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/jquery.mobile-1.3.0.min.css" />
    <script src="js/jquery-1.8.2.min.js"></script>
    <script src="js/jquery.mobile-1.3.0.min.js"></script>
    <script>
    </script>
   
</head>
<body>
 <div data-role="page" id="caseMain">

        <!-- <div data-role="header" data-position="fixed" data-id="header1" data-tap-toggle="false">
            <h1 data-theme="e">Elaw.my</h1>
            <a id="linkback" href="searchItems.html" data-icon="arrow-l" data-theme="b">Back</a>
            <a href="index.html" data-icon="gear" class="ui-btn-right" data-theme="b">Home</a>  
        </div> --><!-- /header -->
         <div data-role="content">
           <div id="results">
           	
           </div>
           <button id="nextPage" data-mini="true">Read More</button>
       </div> <!-- ending content -->
        <div data-role="footer" data-tap-toggle="false" data-id="footer1" data-position="fixed">        
            <div data-role="navbar">
                <ul id="footerList">
                    <li><a id="goBack" href="searchItems.html">Go back</a></li>
                    <li><a href="caseSearch.html" class="" data-theme="b">Cases</a></li>
                    <li><a href="legislationSearch.html">Legislation</a></li>
                    <li><a href="#popupMenu" data-rel="popup" data-role="button" data-inline="true">More</a></li>
                </ul>
            </div><!-- /navbar -->
        </div><!-- /footer --> 
        <div data-role="popup" id="popupMenu"> 
            <ul data-role="listview" data-inset="true" style="min-width:210px;">
                <li><a href="#searchPopUp" data-rel="popup" data-position-to="window">Search</a></li>
                <li><a href="references.html">References</a></li>
                <li><a href="help.html">Help</a></li>                            
                <li><a href="index.html">Home</a></li>                            
            </ul>
        </div>        
         <div data-role="popup" id="searchPopUp">
                <div style="padding:10px 20px;">
                    <input data-mini="true" id="searchText" name="search" type="text">
                    <button id="searchInside" data-mini="true" data-inline="true">Search</button>
                    <button id="closeSearchBox" data-mini="true" data-inline="true">Close</button>
                </div>
        </div>        
        
    <script>
        //$("#searchInside").on('vclick',function(){
        function replaceAll(find, replace, str) {
          return str.replace(new RegExp(find, 'g'), replace);
        }
        $('button').on('vclick',function(){
            //console.log($(this).attr('id'));
            if($(this).attr('id') == 'searchInside'){
                var query = $("#searchText").val(); 
                console.log('clicked');
                searchIt(query);
                //$.searchNext = false;
            }
            if($(this).attr('id')=='closeSearchBox'){
                $("#searchPopUp").popup("close");
                $("#searchPopUp").toggle(false);
            }
            //return false;
        });
        function callback(match, p1) {
            return ((p1 == undefined) || (p1 == '')) ? match : '<span class="found">' + match + '</span>';
        }
        function surroundTags(search) {
              $('#results').html($('#results').html().replace(new RegExp("<[^>]+>|&nbsp;|&amp;|(" + search + ")", 'ig'), callback));
        }
        function remTags() {
            $('.found').contents().unwrap();
        }
        $("#searchPopUp").on('popupafteropen',function(){
            var $$ = $(this);
            var width = $$.width;
            $$.css('position','fixed');
            $$.css('top','25px');
            $$.css('left','60px');
            $$.toggle(true);
        });
        function searchIt(query){
            var newSearch = false;
            if(!$.searchQuery){
                $.searchQuery = query
                newSearch = true;
            }
            else{
                if($.searchQuery != query){
                    remTags();
                    $.searchQuery = query;
                    newSearch = true;
                }
            }
            //console.log(query);
            var content = $("#results").html();
            var result  = content.indexOf(query);
            console.log('index '+result);
            if(result != -1){
                var replaced = content.indexOf('<span class="scrollTo">'+query+'</span>');
                if(replaced == -1){
                    //console.log('not replaced');
                    $.searchNext = false;
                    content = replaceAll(query,'<span class="scrollTo">'+query+'</span>',content);
                    $("#results").html(content);
                    $.searchCount = $(".scrollTo").length; 
                }
                if($.searchNext){
                    //console.log('remainder is '+$.searchNext%$.searchCount+' and count is '+$.searchCount);
                    var n = $.searchNext%$.searchCount;
                    $.searchNext+=1;
                }
                else{
                    $.searchNext = 1;
                    var n = 0;
                }

                console.log("number n "+n);
                var offset = $(".scrollTo:eq("+n+")").offset().top;
                console.log(offset+' offset 2');
                $('html, body').animate({ scrollTop:offset},500,function(){
                    console.log('animation done');
                    $("#searchPopUp").css("top",$.offset+10);
                    var offset1 = $("#searchPopUp").offset().top;
                   console.log(offset1+' offset 1'); 
                });
                //$("#searchPopUp").popup("close");
            }
        }
    function makeUrl(p){
        var filename = $.filename;
        //var ec = $.urlParam('ec');
        var url = 'http://elaw.com.my/Elawf4/mobile/searchresultmobile.aspx?filename='+filename;
        var page = '';
        $.casePage += 1;
        page = $.casePage;           
        url += '&p='+page;
        url += '&callback=?';
        //console.log(url);
        return url;
    }
    $("#nextPage").on('vclick',function(){
        //console.log();
        var url = makeUrl();
        if($.casePage <= $.lastPage){
            $.getJson(url,'caseMain');
            $.mobile.loading('show');
        }
    });
    function loadNext(){
        if(!$.lastPage){
            setTimeout(loadNext,100);
        }
        else{
            for(var i=0;i<$.lastPage;i++){
                urltext = makeUrl();
                $.getJson(urltext,'caseMain');
            }
        }
    }
    function runIt(){
        $.casePage = 0;
        $.scrollAndLoad = true;
        var urltext = makeUrl();
        $.mobile.loading('show');
        $.getJson(urltext,'caseMain');
        if($.latest){
            $("#goBack").attr('href','latest.html');
            $.latest=false;
            console.log($.latest);
            console.log($("#goBack").attr('href'));
        }
        loadNext();
    }
    function runIt2(){
        if($.latest){
            $("#goBack").attr('href','latest.html');
            $.latest=false;
            console.log($.latest);
            console.log($("#goBack").attr('href'));
        }
    }
    $('#caseMain').on('pageshow', runIt);  
    $('#caseMain').on('pageinit', runIt2);  
    </script>
    </div>
</body>
<html>
