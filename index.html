<!DOCTYPE html>
<html>
<head>
    <title>Elaw.my</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/jquery.mobile-1.3.0.min.css" />
    <script src="js/jquery-1.8.2.min.js"></script>
    <script src="js/jquery.mobile-1.3.0.min.js"></script>
    <script>
   
    </script>
    <style>
        #list{
            margin-bottom: 20px;
        }
    </style>
</head>
<body>

<div id="main" data-role="page">
	<div data-role="panel" id="mypanel" data-display="overlay" data-dismissible="true">		  
            <div>
              <h3 align="center">Please sign in</h3>
              <label for="un" class="ui-hidden-accessible">Username:</label>
              <input name="user" id="un" value="" placeholder="username" type="text">
              <label for="pw" class="ui-hidden-accessible">Password:</label>
              <input name="pass" id="pw" value="" placeholder="password" type="password">
              <button id="login" data-icon="check">Sign in</button>
			  <p id="error" style="color:red;"></p>
            </div>
			<div>
				<h3 align="center">Or register ?</h3>
				<button id="register">Open browser</button>
			</div>
		<!-- panel content goes here -->
	</div><!-- /panel -->

    <div data-role="header" data-position="fixed" data-id="header1">
        <h1>Elaw.my</h1>
        <a href="" data-icon="home" data-theme="b">Home</a>
        <a href="options.html" data-icon="gear" class="ui-btn-right" data-theme="b">Options</a>


    </div><!-- /header -->

    <div data-role="content">
        <article>
    <ul data-role="listview" id="mylist" >
        <li>
            <!-- <img class="ui-li-thumb" src="icons/Documents-icon_2.png"> -->            
            <a href="latestCases.html">         
                <img src="icons/Documents-icon_2.png" class="ui-li-thumb">
                <h1 class="ui-li-heading">Lates cases</h1>           
                <p class="ui-li-desc">view latest cases</p>
            </a>
            <span id="num" class="ui-li-count ui-btn-up-c ui-btn-corner-all">12</span>
        </li>
        <li>
            <!--<a href="caseSearch.html">-->
            <a id="caseClick" href="caseSearch.html" data-rel="panel">
            <img src="icons/searchIcon.png" class="ui-li-thumb">
            <h1>Case search</h1>           
            <p>search for cases</p>
            </a>
        </li>
        <li>
            <a id="legislationClick" href="legislationSearch.html" data-rel="panel">
            <img src="icons/legislation.png" class="ui-li-thumb">
            <h1>Legislation search</h1>           
            <p>search for legislations</p>
            </a>
        </li>
        <li>
            <a id="referencesClick" href="#mypanel">
            <img src="icons/searchIcon2.png" class="ui-li-thumb">    
            <h1>References</h1>           
            <p>read the references</p>
            </a>
        </li>
        <li>
            <a href="#">
            <img src="icons/helpIcon.png" class="ui-li-thumb">    
            <h1>Help</h1>           
            <p>look for help</p>
            </a>
        </li>
    </ul>
</article>
         
     </div><!-- /content -->

        <div data-role="footer" data-position="fixed" data-id="footer1">        
            <div data-role="navbar">
                <ul>
                    <li><a href="latestCases.html" data-icon="star">Latest</a></li>
                    <li><a id="caseClick1" href="#mypanel" data-icon="search">Cases</a></li>
                    <li><a id="legislationClick1" href="#mypanel" data-icon="search">Legislation</a></li>
                    <li><a id="referencesClick1" href="#mypanel" data-icon="info">References</a></li>
                    <li><a href="help.html" data-icon="alert">Help</a></li>
                </ul>
            </div><!-- /navbar -->
        </div><!-- /footer -->   
		<script>
		$("#register").on("click",function(){
			url = "http://elaw.com.my/test2/subscription_single_corporate.aspx"
			navigator.app.loadUrl(url, { openExternal:true });			
		});
        $('#main').on('pageinit',function(){
            $("#main #login").on("click",function(){
                //console.log('login click ?');
                $("#error").html("");
                var username = $("#un").val();
                var password = $("#pw").val();
                if(username && password){
                    $.u = username;
                    url = 'http://elaw.com.my/Elawf4/mobile/loginmobile.aspx?u='+username;
                    url += '&pass='+password;
                    url += '&callback=?';
                    $.getJson(url,"main");
                }
            });

            $("#main a").on("click",function(){
                //console.log($(this).attr('id')+" "+$(this).attr('href'));
                var obj = $(this);
                //console.log(obj.attr('id'));
                if(obj.attr('id') == 'caseClick' || obj.attr('id')=='caseClick1'){
                    $.redirectTo = 'caseSearch.html';
                }
                if(obj.attr('id') == 'legislationClick1' || obj.attr('id')=='legislationClick'){
                    $.redirectTo = 'legislationSearch.html';
                }
                if(obj.attr('id') == 'referencesClick' || obj.attr('id')=='referencesClick1'){
                    $.redirectTo = 'references.html';
                }
                if($.u){
                    console.log($.u);
                    //$(this).stopPropagation();
                    $.mobile.changePage($.redirectTo);
                    //return false; // should I do this ???
                }
                    
            });        
        });
		</script>
        </div><!-- /page -->

</body>
<script>
    $.handleData = function(data,pageId){
        //console.log(data);
        if(pageId == "main"){
            if(data.reply == "loggedin"){
                console.log('loggedin');
                console.log($.redirectTo);
                $.mobile.changePage($.redirectTo);
            }   
            else{
                //console.log('what');
                $.u = false;
                $("#error").html(data.reply);
            }
        }
        if(pageId == "caseSearchResults"){
            var html = '';
            console.log(data);
            $.each(data.results,function(index,elem){
                if(index != 'pages'){
                      html += '<li name="'+elem.fileName+'"><a href="#" name="'+elem.fileName+'"><h1>'+elem.title+'</h1><p>'+elem.Court+'</p></a></li>';
                }                  
            });
            if(html === ''){
                html = '<li>No results</li>'
                //console.log(html);
                }
            $('#caseSearchResults #mylist2').html(html);
            $('#caseSearchResults #mylist2').listview('refresh'); 
            $.mobile.loading('hide');
            //return html;
        }
        if(pageId == "caseMain"){
            console.log(data);
            var html = '';
                //console.log(data);
                if (data){
                    //var lastPage = Integer.parseInt(data.lastPage);                    
                    if($.page==1){
                        var title = '<h2 align="center">'+data.result.Title+'</h2>';
                        html+= title;
                        $.lastPage = parseInt(data.result.lastPage);
                    }                    
                        html+= data.result.JudgementBody;                                                                    
                }
                else{
                    html='<h2 align="center">No content to display</h2>'
                }
                if($.page > 1)
                    $("#caseMain #results").append(html);
                else
                    $("#caseMain #results").html(html);
                //$.scroll = true;
                $.scrollAndLoad = true;
                $.mobile.loading('hide');
        }
        if(pageId == "lsResult"){
            var html = '';
            if(data.results.pages){
            $.each(data.results,function(index,elem){
                //elem.fileName
                if(index%10 < 11){
                html += '<li name="'+elem.fileName+'"><a href="#"><h1>'+elem.title+'</h1><p>'+elem.Preamble+'</p></a></li>';}
            });            
            var lastpage = parseInt(data.results.pages.LastPage);            
            var currentpage = parseInt(data.results.pages.CurrentPage);
            $.lastPage = lastpage;
            $.currentPage = currentpage;
            /*$.nextPage = currentpage+1;
            $.prevPage = currentpage-1;
            if($.nextPage > lastpage)
                $.nextPage = lastPage;
            if($.prevPage < 1)
                $.prevPage = 1;*/
            $.nextPage+1 > lastpage ? $.nextPage = lastPage : $.nextPage = currentpage+1;
            $.prevPage-1 < 1 ? $.prevPage = 1 : $.prevPage = currentpage-1;
                
            $("#lsResult #lp").html('Last page: '+$.lastPage);
            $("#lsResult #cp").html('Current page: '+$.currentPage);
            //setPage(lastpage);
            }
            if(html == ''){
                html = '<li>No results</li>'
                $("#lsResult #lp,#lsResult #cp").html('');
            }
                $('#lsResult #mylist2').html(html);
                $('#lsResult #mylist2').listview('refresh');
                $.mobile.loading('hide');
        }
        if(pageId == 'lssResult'){
            var html = '';
            //console.log(data);
            //console.log(data.results[0]);
            $.each(data.result,function(index,elem){                
            //html += '<li><a href="case2.html?filename='+filename+'&part='+index+'" rel="external"><h1>'+elem+'</h1><p>'+index+'</p></a></li>';
            html += '<li name="'+$.fileName+'" part="'+index+'"><a href="#"><h1>'+elem+'</h1><p>'+index+'</p></a></li>'
            });
            if(html === ''){
                html = '<li>No results</li>'
            }
                $('#lssResult #mylist2').html(html);
                $('#lssResult #mylist2').listview('refresh');
        }
        if(pageId == 'briefcasePage'){
            var html = '';              
                $.each(data,function(){
                    if(data.result.Title){
                    html += '<li name="'+data.result.xmlFileName+'"><a href="#"><h1>'+data.result.Title+'<h1></a></li>';  
                    }
                    
                });
                if(!html){
                    $("#nohtml").html('<h2>No cases saved</h2>');
                    $("#nohtml").attr('align','center')
                }
                else{
                    $("#briefcaseId").html(html);
                    $("#briefcaseId").listview("refresh");              
                }
        }


        
    }
    $.getJson = function(url,pageId){
        /*console.log("getjson "+url+" "+pageId);
        data = {};
        data.reply = 'loggedin'*/
        $.getJSON(url,function(data){
            $.handleData(data,pageId);
        });
        //$.handleData(data,pageId);
    }
</script>
</html>